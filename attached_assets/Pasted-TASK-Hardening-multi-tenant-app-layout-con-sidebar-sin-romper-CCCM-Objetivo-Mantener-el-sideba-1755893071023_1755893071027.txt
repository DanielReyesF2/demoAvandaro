TASK: Hardening multi-tenant app (layout con sidebar, sin romper CCCM)

Objetivo

Mantener el sidebar original como layout principal.

Aislamiento total por client_id + RLS.

Admin EcoNova con dashboard global en /admin.

Tenants: cccm (con datos), club-de-golf-avandaro, rancho-avandaro (sin datos).

Personalización por cliente vía settings y feature flags (sin ifs por slug).

Acciones

Rutas y layout

/:clientSlug/* usa TenantSidebar + TenantLayout.

/admin/* usa AdminSidebar (simple), con selector de clientSlug para “ver como”.

Auth/Context

Resolver client_id por clientSlug en middleware backend; inyectar en req.context.

JWT con scopes (admin:global | portal:*). No aceptar client_id desde el frontend.

RLS (todas las tablas con client_id)

Políticas select/modify que permitan:

clientes: client_id = jwt.client_id

admin global: jwt.scopes contiene admin:global

Agregar tests de autorización por tabla.

Branding y módulos

Tablas: client, client_settings, client_feature_flags.

Al montar /:clientSlug/*, cargar branding y aplicar tema.

En sidebar, mostrar módulos según feature_flags.

Tenants

Seed: cccm (migrar data existente con su client_id).

Crear club-de-golf-avandaro y rancho-avandaro sin data (solo client, settings básicos).

Exportar/Reportes

Endpoints export/* y reports/* deben forzar filtro por client_id del contexto.

Storage

Prefijo por cliente: files/{client_id}/… con reglas atadas al JWT.

Provisioning CLI

scripts/provision_tenant.ts: crear cliente, opcional invitar usuarios, setear settings/flags, crear prefijos de storage.

Admin global

/admin muestra métricas agregadas (si solo hay datos de CCCM, solo se ve CCCM por ahora).

Vista /admin/tenants para editar logo/colores/flags.

Definición de “Done”

Sidebar estable en /:clientSlug/*.

Cambiar de cliente no mezcla datos ni colores.

RLS probadas; intentos cross-tenant fallan.

Exports/reports respetan client_id.

CLI de provisioning funcionando con los 2 tenants nuevos.

Nota: No inventar datos para Avándaro/Rancho Avándaro; solo estructura y branding por default.